---
title: "Segregation Empirical Work"
author: "Erik B. Johnson"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes: 
  - \usepackage{dcolumn}
urlcolor: "blue"
output: 
    pdf_document:
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(zipcode)
library(ggmap)
library(googleway)
library(data.table)
library(rgdal)
library(rgeos)
library(utils)
library(stringr)
library(xtable)
library(stargazer)
library(seg)
library(transport)
library(stats) # For reshape
library(rgdal)
library(maptools)
library(plyr)
suppressMessages(library(bit64))


#source('locations.segregation.R')
load('~/Dropbox/pkg.data/api.keys/raw/l.pkg.rdata')
api.key <- l.pkg$google

# File Locations
combs.richmond.centroids.location <- 'CleanData/combs.richmond.centroids.rdata'
dists.richmond.location <- 'CleanData/dists.richmond.rdata'
dists.richmond.new.location <- 'CleanData/dists.richmond.new.rdata'
dists.richmond.raw.new.location <- 'CleanData/dists.richmond.raw.new.rds'
census.location <- 'CleanData/census.rdata'
census.commute.location<- 'CleanData/census.commute.rdata'
census.income.location <- 'CleanData/census.income.rdata'
census.race.location <- 'CleanData/census.race.rdata'
measures.wasserstein.location <- 'CleanData/measures.wassersteing.rdata'
shapes.richmond.tracts.location <- 'CleanData/shapes.richmond.tracts.rdata'
shapes.richmond.centroids.location <- 'CleanData/shapes.richmond.centroids.rdata'
shapes.proj.env.location <- 'CleanData/shapes.proj.env.rds'

f_list <- paste0('R/', list.files('R'))
for(file in f_list){
    cat(file, '\n')
    source(file)
}
```

# Description

Data work and documentation for the Richmond transportation/segregation paper.

# Background

Really seems that we should focus on the commuting component of transportation (empirical and theoretical reasons.)

This is a list of possible sources to help motivate our paper.

*   [Commuting to Opportunity](`r URLencode('https://web.stanford.edu/group/scspi/_media/pdf/key_issues/transportation_policy.pdf')`)
*   [Commuting in America](`r URLencode('http://traveltrends.transportation.org/Documents/CA10-4.pdf')`)
*   [Low income commuters and Cycling](`r URLencode('https://www.citylab.com/transportation/2014/07/how-low-income-commuters-view-cycling/374390/')`)

\clearpage

# Data

## Change in Travel times
```{r dists.richmond, echo=FALSE}
l_dists_richmond <- funDistances_combine()
```

First, use google travel times to build \textbf{dists.richmond} for distances (meters) and travel times (seconds) by mode to and from all census tracts.
Based on tract-centroids to tract-centroids. Distance is non-euclidean. For google distance and time calculation documentation see: 
[Google distance api documentation](`r URLencode('https://developers.google.com/maps/documentation/distance-matrix/intro')`)

Summary statistics for \textbf{dists.richmond} (where NA transit values default to walking values):
```{r results='asis', echo=FALSE}
dt_dists <- rbindlist(l_dists_richmond, use.names=TRUE, fill=TRUE)
dt_cast <- dcast(dt_dists, origin.tract + dest.tract ~ mode + scrapeDate, value.var='distance_seconds')
stargazer(dt_cast, summary=TRUE, header=FALSE, nobs=FALSE, digits=0, align=T, style='qje', title=paste0('Pairwise Distance Summary'))
```

Change in Travel times

```{r results='asis', echo=FALSE}
dt_transit <- dt_cast[, .(origin.tract, dest.tract, seconds2017 = `transit_03-2017`, seconds2018 = `transit_03-2018`)]
dt_transit <- dt_transit[, pct_increase:=(seconds2018-seconds2017)/seconds2017]
dt_transit <- dt_transit[pct_increase != 0]
ggplot2::ggplot(dt_transit, aes(pct_increase*100)) + geom_histogram(bins=50) + xlab('Percent change tract to tract Public Transit Times 2017 to 2019') + geom_vline(xintercept=0, color='white')
ggsave('Figures/hist_pctChng_transitTimes.pdf')
```


# Which tracts have the largest changes in travel times?
```{r results='asis', echo=FALSE}
dt_origin_changes <- dt_transit[, .(mean_pct_increase=mean(pct_increase), sd_pct_increase=sd(pct_increase)), by=origin.tract][order(-mean_pct_increase)]


# Plot these
shps <- funShapes.richmond.tracts()
shp_fortify <- fortify(shps, region='GEOID')
setnames(dt_origin_changes, 'origin.tract', 'id')
tracts.df <- join(dt_origin_changes, shp_fortify, by='id')
census <- funCensus()
setnames(census, 'tract', 'id')
tracts.df <- join(census, tracts.df, by='id')
tracts.df$pct_black <- tracts.df$black.n/tracts.df$race.total.n
ggplot(tracts.df, aes(long, lat, group=group, fill=mean_pct_increase)) +  geom_polygon() + coord_equal() 
ggplot(tracts.df, aes(long,lat, group=group, fill=pct_black))+geom_polygon() + coord_equal()
```

\clearpage

## Census [census]

The \textbf{census} dataset consists of the following fields:

```{r results='asis', echo=FALSE}
#census <- funCensus()
#stargazer(census, summary=TRUE, header=FALSE, nobs=FALSE, digits=0, align=T, style='qje', title='Tract Level Summary Statistics')
```

The construction of the census table is documented in Table \ref{dt.census}. For more specifics see \textit{funCensus.income, funCensus.commute, funCensus.race} in the file \texttt{functions.segregation.R}. 

```{r results='asis', echo=FALSE}
#cap <- '2011-2015 ACS 5-Year Estimates, Geography: Tract'
#x.out <- capture.output(print(xtable(funCensus.tables(), caption = cap, label='dt.census'),  include.rownames=FALSE, comment=FALSE, #caption.placement = 'top'))
#cat(x.out,sep = '\n')
```

\clearpage

# Measuring segregation

We begin by estimating the amount of segregation in the city with a variety of traditional segregation measures (from the R library \texttt{seg})\footnote{Documentation and explaination at (http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0113767) and Reardon and O'Sullivan (2004)}. Interestingly, there have been a variety of measures which include a variety of spatial terms that uses information on neighbors and shared borders. These measures are, however, fundamentally different from our new one since spatial distance is a matrix that incorporates a variety travel times between tracts over the entire city. 


## Dissimilarity
```{r, echo=FALSE, eval=FALSE}
dissimilarity <- funMeasures.dissimlarity(census)
```
We begin by calculating a simple dissimlarity index between two groups $X$ and $Y$ in locations $i$ described in Equation \eqref{eq:D}. Higher values of dissimilarity imply more wihtin tract race distributions. Note again that this measure is inherently aspatial and only uses the tract level census data. Note that the 'nb' term in \texttt{seg} library scales the interaction of the iteraction is normalized to 1 and not appropriate for our application. Additional information on the library can be found at the [Stanford Dissimilarity](http://stanford.edu/~ejdemyr/r-tutorials/segregation/). Empirical results are shown in Table \ref{tbl:D}. We can see that the most spatially dissimilar races according to this measure are with a value of

\begin{equation}\label{eq:D}
D = \frac{1}{2}\sum_{i=1}^n\left|\frac{x_i}{X}- \frac{y_i}{Y}\right|
\end{equation}

```{r tbl:D, results='asis', echo=FALSE, eval=FALSE}
cap <- 'Dissimilarity Index'
lab <- 'tbl:D'
x.out <- capture.output(print(xtable(dissimilarity, caption = cap, label=lab),  include.rownames=FALSE, comment=FALSE, caption.placement = 'top', round=2))
cat(x.out,sep = '\n')
```

## Wasserstein Measure
```{r, eval=FALSE}
l.wasserstein <- list()
for(dists.richmond in l_dists_richmond){
    l.wasserstein <- funMeasures.wasserstein(census, dists.richmond)
}
```
The two main drawbacks of the $D$ measure are the lack of spatial information (distance) between populations and the fact that there is no direction implied in the relationship. Next, we measure dissimilarity through a Wasserstein measure, which will include both the spatial information and has the ability to infer directional relationships in the form of an asymmetric graph. This is a two stage process and requires careful selection of counterfactuals.  We begin with the most simple formulation\footnote{The Wasserstein measure is found in the R  \texttt{transport} package.}.





